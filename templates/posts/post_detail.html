{% extends 'base.html' %}
{% load static %}
{% load suggestion_tags %}

{% block title %}Bakla by {{ post.author.username }} - Bakla{% endblock %}

{% block content %}
<div style="padding: 0 20px;">
    <header style="padding: 15px 0;">
        <h1 style="font-size: 20px; margin: 0;">Bakla</h1>
    </header>
    
    <!-- KONUŞMA ZİNCİRİ GÖSTERİMİ -->
    {% for parent_post in conversation_chain %}
        <div class="parent-post-container">
            {% include 'includes/post_template.html' with post=parent_post %}
        </div>
    {% endfor %}

    <!-- Ana Odak Post -->
    <div class="main-post-full {% if conversation_chain %}is-reply-to-chain{% endif %}" style="padding-top: 15px;" id="post-{{ post.pk }}">
        <div class="post-author-details" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <a href="{% url 'profile' post.author.username %}">
                <img src="{% if post.author.profile.profile_photo %}{{ post.author.profile.profile_photo.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}" alt="{{ post.author.username }}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
            </a>
            <div>
                <p style="margin: 0; font-weight: bold;">
                    <a href="{% url 'profile' post.author.username %}" style="color: inherit;">{{ post.author.get_full_name }}</a>
                </p>
                <p style="margin: 0; color: #536471;">@{{ post.author.username }}</p>
            </div>
        </div>

        <div class="post-content-full" style="font-size: 22px; margin-bottom: 15px;">
            {{ post.content|safe|linkify }}
        </div>
        
        {% if post.image %}
        <div class="post-image-container" style="margin-bottom: 15px;">
            {# YENİ YAPI: <a> etiketi yok. data-large-url eklendi. #}
            <img 
                src="{{ post.image.url }}" 
                data-large-url="{{ post.image.url }}" 
                alt="Bakla Resmi" 
                class="post-image-clickable" 
                style="width: 100%; max-width: 500px; border-radius: 15px; border: 1px solid #eee; cursor: pointer;"
            >
        </div>
        {% endif %}

        <p class="post-meta" style="border-top: 1px solid #eff3f4; padding-top: 15px; margin-bottom: 15px; color: #536471;">
            {{ post.created_at|date:"H:i · d M Y" }}
        </p>

       <!-- <div class="post-stats" style="border-top: 1px solid #eff3f4; padding-top: 15px; display: flex; gap: 20px; font-family: Verdana, sans-serif;">
            <span><b>{{ post.replies.count }}</b> Yanıt</span>
            <span><b>{{ post.likes.count }}</b> Beğeni</span>
        </div> --> 
        
        <div class="post-actions" style="border-top: 1px solid #eff3f4; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-around; align-items: center;">
    <div title="Yanıtla"><i data-feather="message-circle" style="width: 24px; height: 24px; color: #657786;"></i>  <span class="like-count">{{ post.replies.count }}</span></div>
    
   <button class="like-btn" data-post-id="{{ post.pk }}" title="Beğen" style="background: none; border: none; padding: 0; cursor: pointer; display:flex; align-items:center; gap: 8px; font-family: Verdana, sans-serif; font-size: 14px;">
                <i data-feather="heart" class="like-icon {% if user in post.likes.all %}liked{% endif %}" style="width: 24px; height: 24px;"></i>
                <span class="like-count {% if user in post.likes.all %}liked-text{% endif %}">
                    {{ post.likes.count }} 
                </span>
            </button>

           <!-- PAYLAŞ BUTONU GÜNCELLENDİ (a -> button) -->
    <button class="share-btn action-item" data-post-id="{{ post.pk }}" title="Paylaş">
        <i data-feather="repeat" class="share-icon {% if user in post.shared_by.all %}shared{% endif %}" style="width: 24px; height: 24px;"></i>
        <span class="share-count {% if user in post.shared_by.all %}shared-text{% endif %}">{{ post.shared_by.count }}</span>
    </button>

             {% if request.user == post.author %}
                <button class="delete-btn" data-post-id="{{ post.pk }}" data-source="detail-page" title="Sil" style="background: none; border: none; padding: 0; cursor: pointer;">
                    <i data-feather="trash-2" style="width: 24px; height: 24px; color: #657786;"></i>
                </button>
             {% endif %}

</div>
    </div>
    
   <hr style="margin-top: 20px;">

<!-- YANIT FORMU (YENİ VE İYİLEŞTİRİLMİŞ GÖRÜNÜM) -->
<div class="post-form-container" id="reply-form" style="border-bottom: 10px solid #f0f2f5;">
    
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="mention" value="@{{ post.author.username }}">
            
            {# Yeniden kullanılabilir ve şık form şablonunu burada çağırıyoruz #}
            {# Not: Kendi avatarımızı gösteriyoruz, çünkü YANITI BİZ yazıyoruz #}
            {% include 'includes/post_form_content.html' with form=reply_form user=request.user button_text="Yanıtla" %}

        </form>
</div>

    <hr>
    <!-- Yanıtlar -->
    <div class="timeline">
        <h3 style="padding: 0 15px;">Yanıtlar</h3>
        {% for reply in replies %}
            {% include 'includes/post_template.html' with post=reply %}
        {% empty %}
            <p style="padding:15px; text-align: center; color: #536471;">Bu baklaya henüz yanıt verilmedi.</p>
        {% endfor %}
    </div>

    <div id="infinite-scroll-trigger"></div>
</div>
{% endblock %}